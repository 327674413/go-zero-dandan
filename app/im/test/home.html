<!DOCTYPE html>
<html lang="en">
<head>
  <title>Chat Example</title>
  <script type="text/javascript">
    var conn;
    var userToken = ''
    window.onload = function () {
      var msg = document.getElementById("msg");
      document.getElementById("form").onsubmit = function () {
        if (!conn) {
          return false;
        }
        if (!msg.value) {
          return false;
        }
        sendChatText(msg.value);
        msg.value = "";
        return false;
      };

    };
    function sendChatText(text){
      let data = {text:text,type:'CHAT_TEXT',id:Date.now() + '' + Math.floor(Math.random() * 10) + 10001}
      conn.send(JSON.stringify(data));
      data.state = 0;
      appendSendChatText(data)
    }
    function tapLogin(token = ""){
      var addr = $('#ws-addr').value
      token = token ? token : $('#user-token').value
      if (!addr) return alert('请输入ws地址')
      userToken = token
      connect(addr + "?platformEm=1&token=" + token)
    }

    function connect(addr){
      if (window["WebSocket"]) {
        conn = new WebSocket(addr);
        conn.onopen = function(){
          $('#chat').style.display = "block"
          $('#login').style.display = "none"
          var item = document.createElement("div");
          item.innerHTML = "<b>连接成功</b>";
          appendLog(item);
          //这里可能要放到onmessage了收到登录成功的消息后再处理
          post("http://localhost:8801/user/v1/getMyCronyList").then(res=>{
            console.log(res)
          })
        }
        conn.onclose = function (evt) {
          var item = document.createElement("div");
          item.innerHTML = "<b>Connection closed.</b>";
          appendLog(item);
        };
        conn.onmessage = function (evt) {
         let data = JSON.parse(evt.data);
          appendRecvChatText(data)
        };
        conn.onerror = function (evt) {
          console.error(evt.message,evt.reason,evt.code)
          alert("websocket 连接失败")
        };
      } else {
        alert("浏览器不支持socket连接")
      }
    }
    function appendSendChatText(data){
      var item = document.createElement("div");
      item.className = 'fr chat-msg-item send'
      item.innerHTML = '<span class="chat-msg-state">发送中</span><div class="chat-msg-wrapper"><div class="fr chat-msg-name">我</div><div class="fl chat-msg-content">' +data.text +'</div></div><div class="chat-msg-avatar"></div>';
      appendLog(item);
    }
    function appendRecvChatText(data){
      var item = document.createElement("div");
      item.className = 'fl chat-msg-item recv'
      item.innerHTML = '<div class="chat-msg-avatar"></div><div class="chat-msg-wrapper"><div class="fl chat-msg-name">对方名字</div><div class="fl chat-msg-content">' +data.text +'</div></div>';
      appendLog(item);
    }
    function appendLog(item) {
      var log = document.getElementById("log");
      var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
      log.appendChild(item);
      if (doScroll) {
        log.scrollTop = log.scrollHeight - log.clientHeight;
      }
    }
    function $(selector){
      return document.querySelector(selector)
    }

    function post(url,data){
      return new Promise(function(resolve, reject) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("Authorization", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTM3Mjg4MTEsImlhdCI6MTY4NzY4MDgxMSwicGxhdENsYXNFbSI6MSwicGxhdElkIjoxfQ.b-4nDvO4yKH4lfnHPHEEcQDWP_KI7f_PxvWkLm5Oc2Y");
        xhr.setRequestHeader("Token", userToken);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              var response = JSON.parse(xhr.responseText);
              resolve(response);
            } else {
              reject(xhr.status);
            }
          }
        };
        xhr.send(JSON.stringify(data));
      });

    }
  </script>
  <style type="text/css">
    html {
      overflow: hidden;
    }

    body {
      overflow: hidden;
      padding: 0;
      margin: 0;
      width: 100%;
      height: 100%;
    }

    #log {
      background: #f4f4f4;
      margin: 0;
      padding: 0.5em 0.5em 0.5em 0.5em;
      position: absolute;
      top: 0.5em;
      left: 0.5em;
      right: 0.5em;
      bottom: 3em;
      overflow: auto;
    }

    #form {
      padding: 0 0.5em 0 0.5em;
      margin: 0;
      position: absolute;
      bottom: 1em;
      left: 0px;
      width: 100%;
      overflow: hidden;
    }
    .fl{display: flex;align-items: center;}
    .fr{display: flex;align-items: center;justify-content: flex-end;}
    .fc{display: flex;align-items: center;justify-content: center;}
    .fb{display: flex;align-items: center;justify-content: space-between;}
    #chat{width:100vw;height:100vh;display: none;background: gray;}
    #login{width:100vmin;height:100vmin;position: absolute;left:50%;top:50%;transform: translate(-50%,-50%);background: #f8f8f8;}
    .login-item{display: flex;align-items: center;padding:.5em 1em;}
    #ws-addr{width:40em;}
    .login-btn{padding:10px; margin-right:20px;}
    .chat-msg-state{padding:0 5px;font-size:12px;color:red;}
    .chat-msg-name{font-size:14px;color:#8a8a8a;padding:2px;}
    .chat-msg-content{border-radius: 8px;padding:10px;align-items: flex-end;margin-bottom: 10px;position: relative;}
    .recv .chat-msg-content{background: #E5E5EA;}
    .send .chat-msg-content{background: #95EC69;}
    .chat-msg-avatar{width:50px;height:50px;border-radius: 10px;}
    .recv .chat-msg-avatar{margin-right:10px;background: #06f;}
    .send .chat-msg-avatar{margin-left:10px;background: #f60;}
    .recv .chat-msg-content::after {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
      border-right: 5px solid #E5E5EA;
      left: -5px;
      top: 8px;
    }
    .send .chat-msg-content::after {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
      border-left: 5px solid #95EC69;
      right: -5px;
      top: 8px;
    }
  </style>
</head>
<body>
<div id="login">
  <p class="login-item">websockt地址：<input type="text" value="ws://localhost:8808/connection" id="ws-addr" /></p>
  <p class="login-item">用户token：<input type="text" value="" id="user-token" /></p>
  <p class="login-item">
    <button class="login-btn" onclick="tapLogin()">自定义token登录</button>
    <button class="login-btn" onclick="tapLogin('2b4252c608174611c6179cacab59979fb9ec478bad51a044a6b3f81856af8e81')">登录用户1</button>
    <button class="login-btn" onclick="tapLogin('fa9703d663c06599a89997a45a4de948c3f4eef7f4555e41b4d5db2c62afd208')">登录用户2</button>

  </p>
</div>
<div id="chat">
  <div id="log"></div>
  <form id="form">
    <input type="submit" value="Send" />
    <input type="text" id="msg" size="64" autofocus />
  </form>
</div>
</body>
</html>